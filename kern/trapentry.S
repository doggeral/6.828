/* See COPYRIGHT for copyright information. */

#include <inc/mmu.h>
#include <inc/memlayout.h>
#include <inc/trap.h>



###################################################################
# exceptions/interrupts
###################################################################

/* TRAPHANDLER defines a globally-visible function for handling a trap.
 * It pushes a trap number onto the stack, then jumps to _alltraps.
 * Use TRAPHANDLER for traps where the CPU automatically pushes an error code.
 *
 * You shouldn't call a TRAPHANDLER function from C, but you may
 * need to _declare_ one in C (for instance, to get a function pointer
 * during IDT setup).  You can declare the function with
 *   void NAME();
 * where NAME is the argument passed to TRAPHANDLER.
 */
#define TRAPHANDLER(name, num)						\
	.globl name;		/* define global symbol for 'name' */	\
	.type name, @function;	/* symbol type is function */		\
	.align 2;		/* align function definition */		\
	name:			/* function starts here */		\
	pushl $(num);							\
	jmp _alltraps

/* Use TRAPHANDLER_NOEC for traps where the CPU doesn't push an error code.
 * It pushes a 0 in place of the error code, so the trap frame has the same
 * format in either case.
 */
#define TRAPHANDLER_NOEC(name, num)					\
	.globl name;							\
	.type name, @function;						\
	.align 2;							\
	name:								\
	pushl $0;							\
	pushl $(num);							\
	jmp _alltraps

.text

/*
 * Lab 3: Your code here for generating entry points for the different traps.
 */
#if 0
#define T_DIVIDE     0		// divide error
#define T_DEBUG      1		// debug exception
#define T_NMI        2		// non-maskable interrupt
#define T_BRKPT      3		// breakpoint
#define T_OFLOW      4		// overflow
#define T_BOUND      5		// bounds check
#define T_ILLOP      6		// illegal opcode
#define T_DEVICE     7		// device not available
#define T_DBLFLT     8		// double fault
/* #define T_COPROC  9 */	// reserved (not generated by recent processors)
#define T_TSS       10		// invalid task switch segment
#define T_SEGNP     11		// segment not present
#define T_STACK     12		// stack exception
#define T_GPFLT     13		// general protection fault
#define T_PGFLT     14		// page fault
/* #define T_RES    15 */	// reserved
#define T_FPERR     16		// floating point error
#define T_ALIGN     17		// aligment check
#define T_MCHK      18		// machine check
#define T_SIMDERR   19		// SIMD floating point error

// These are arbitrarily chosen, but with care not to overlap
// processor defined exceptions or interrupt vectors.
#define T_SYSCALL   48		// system call
#define T_DEFAULT   500		// catchall
#endif

/*
* code from xv6
* if(!($i == 8 || ($i >= 10 && $i <= 14) || $i == 17)){
*        print "  pushl \$0\n";
*/
#if 0
TRAPHANDLER_NOEC(t_divide_handler, T_DIVIDE);		//0
TRAPHANDLER_NOEC(t_debug_handler, T_DEBUG);			//1
TRAPHANDLER_NOEC(t_nmi_handler, T_NMI);				//2
TRAPHANDLER_NOEC(t_brkpt_handler, T_BRKPT);			//3
TRAPHANDLER_NOEC(t_oflow_handler, T_OFLOW);			//4
TRAPHANDLER_NOEC(t_bound_handler, T_BOUND);			//5
TRAPHANDLER_NOEC(t_illop_handler, T_ILLOP);			//6
TRAPHANDLER_NOEC(t_device_handler, T_DEVICE);		//7
TRAPHANDLER(t_dblflt_handler, T_DBLFLT);		//8
												//9
TRAPHANDLER(t_tss_handler, T_TSS);			//10
TRAPHANDLER(t_segnp_handler, T_SEGNP);		//11
TRAPHANDLER(t_stack_handler, T_STACK);		//12
TRAPHANDLER(t_gpflt_handler, T_GPFLT);		//13
TRAPHANDLER(t_pgflt_handler, T_PGFLT);		//14
												//15
TRAPHANDLER_NOEC(t_fperr_handler, T_FPERR);			//16
TRAPHANDLER(t_align_handler, T_ALIGN);		//17
TRAPHANDLER_NOEC(t_mchk_handler, T_MCHK);			//18
TRAPHANDLER_NOEC(t_simderr_handler, T_SIMDERR);		//19
#endif
TRAPHANDLER_NOEC(vector0, T_DIVIDE);			//0
TRAPHANDLER_NOEC(vector1, T_DEBUG);			//1
TRAPHANDLER_NOEC(vector2, T_NMI);			//2
TRAPHANDLER_NOEC(vector3, T_BRKPT);			//3
TRAPHANDLER_NOEC(vector4, T_OFLOW);			//4
TRAPHANDLER_NOEC(vector5, T_BOUND);			//5
TRAPHANDLER_NOEC(vector6, T_ILLOP);			//6
TRAPHANDLER_NOEC(vector7, T_DEVICE);			//7
TRAPHANDLER(vector8, T_DBLFLT);	//8
TRAPHANDLER_NOEC(vector9, 9);				//9
TRAPHANDLER(vector10, T_TSS);		//10
TRAPHANDLER(vector11, T_SEGNP);	//11
TRAPHANDLER(vector12, T_STACK);	//12
TRAPHANDLER(vector13, T_GPFLT);	//13
TRAPHANDLER(vector14, T_PGFLT);	//14
TRAPHANDLER_NOEC(vector15, 15);				//15
TRAPHANDLER_NOEC(vector16, T_FPERR);			//16
TRAPHANDLER(vector17, T_ALIGN);	//17
TRAPHANDLER_NOEC(vector18, T_MCHK);			//18
TRAPHANDLER_NOEC(vector19, T_SIMDERR);		//19
/*
 * Lab 3: Your code here for _alltraps
 */
 _alltraps:
  # push values to make the stack look like a struct Trapframe
  pushl %ds
  pushl %es
  pushal
  # load GD_KD into %ds and %es
  movw $GD_KD, %ax
  movw %ax, %ds
  movw %ax, %es
  # pushl %esp to pass a pointer to the Trapframe as an argument to trap()
  pushl %esp
  call trap
  # because of the env_run of trap, we do not need to call iret

  # vector table
.data
.globl vectors
vectors:
  .long vector0
  .long vector1
  .long vector2
  .long vector3
  .long vector4
  .long vector5
  .long vector6
  .long vector7
  .long vector8
  .long vector9
  .long vector10
  .long vector11
  .long vector12
  .long vector13
  .long vector14
  .long vector15
  .long vector16
  .long vector17
  .long vector18
  .long vector19
  #if 0
  .long vector20
  .long vector21
  .long vector22
  .long vector23
  .long vector24
  .long vector25
  .long vector26
  .long vector27
  .long vector28
  .long vector29
  .long vector30
  .long vector31
  .long vector32
  .long vector33
  .long vector34
  .long vector35
  .long vector36
  .long vector37
  .long vector38
  .long vector39
  .long vector40
  .long vector41
  .long vector42
  .long vector43
  .long vector44
  .long vector45
  .long vector46
  .long vector47
  .long vector48
  .long vector49
  .long vector50
  .long vector51
  .long vector52
  .long vector53
  .long vector54
  .long vector55
  .long vector56
  .long vector57
  .long vector58
  .long vector59
  .long vector60
  .long vector61
  .long vector62
  .long vector63
  .long vector64
  .long vector65
  .long vector66
  .long vector67
  .long vector68
  .long vector69
  .long vector70
  .long vector71
  .long vector72
  .long vector73
  .long vector74
  .long vector75
  .long vector76
  .long vector77
  .long vector78
  .long vector79
  .long vector80
  .long vector81
  .long vector82
  .long vector83
  .long vector84
  .long vector85
  .long vector86
  .long vector87
  .long vector88
  .long vector89
  .long vector90
  .long vector91
  .long vector92
  .long vector93
  .long vector94
  .long vector95
  .long vector96
  .long vector97
  .long vector98
  .long vector99
  .long vector100
  .long vector101
  .long vector102
  .long vector103
  .long vector104
  .long vector105
  .long vector106
  .long vector107
  .long vector108
  .long vector109
  .long vector110
  .long vector111
  .long vector112
  .long vector113
  .long vector114
  .long vector115
  .long vector116
  .long vector117
  .long vector118
  .long vector119
  .long vector120
  .long vector121
  .long vector122
  .long vector123
  .long vector124
  .long vector125
  .long vector126
  .long vector127
  .long vector128
  .long vector129
  .long vector130
  .long vector131
  .long vector132
  .long vector133
  .long vector134
  .long vector135
  .long vector136
  .long vector137
  .long vector138
  .long vector139
  .long vector140
  .long vector141
  .long vector142
  .long vector143
  .long vector144
  .long vector145
  .long vector146
  .long vector147
  .long vector148
  .long vector149
  .long vector150
  .long vector151
  .long vector152
  .long vector153
  .long vector154
  .long vector155
  .long vector156
  .long vector157
  .long vector158
  .long vector159
  .long vector160
  .long vector161
  .long vector162
  .long vector163
  .long vector164
  .long vector165
  .long vector166
  .long vector167
  .long vector168
  .long vector169
  .long vector170
  .long vector171
  .long vector172
  .long vector173
  .long vector174
  .long vector175
  .long vector176
  .long vector177
  .long vector178
  .long vector179
  .long vector180
  .long vector181
  .long vector182
  .long vector183
  .long vector184
  .long vector185
  .long vector186
  .long vector187
  .long vector188
  .long vector189
  .long vector190
  .long vector191
  .long vector192
  .long vector193
  .long vector194
  .long vector195
  .long vector196
  .long vector197
  .long vector198
  .long vector199
  .long vector200
  .long vector201
  .long vector202
  .long vector203
  .long vector204
  .long vector205
  .long vector206
  .long vector207
  .long vector208
  .long vector209
  .long vector210
  .long vector211
  .long vector212
  .long vector213
  .long vector214
  .long vector215
  .long vector216
  .long vector217
  .long vector218
  .long vector219
  .long vector220
  .long vector221
  .long vector222
  .long vector223
  .long vector224
  .long vector225
  .long vector226
  .long vector227
  .long vector228
  .long vector229
  .long vector230
  .long vector231
  .long vector232
  .long vector233
  .long vector234
  .long vector235
  .long vector236
  .long vector237
  .long vector238
  .long vector239
  .long vector240
  .long vector241
  .long vector242
  .long vector243
  .long vector244
  .long vector245
  .long vector246
  .long vector247
  .long vector248
  .long vector249
  .long vector250
  .long vector251
  .long vector252
  .long vector253
  .long vector254
  .long vector255
  #endif
